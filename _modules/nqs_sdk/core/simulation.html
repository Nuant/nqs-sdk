<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nqs_sdk.core.simulation &#8212; NQS SDK 0.6.9.dev0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=8c38d6ca" />
    <script src="../../../_static/documentation_options.js?v=8539da10"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">NQS SDK</a></h1>



<p class="blurb">Python SDK for NQS</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Nuant&repo=nqs-sdk&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core_concepts.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build.html">Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for nqs_sdk.core.simulation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">nqs_sdk.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProtocolFactory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nqs_sdk.nqs_sdk</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProtocolFactoryAdapter</span><span class="p">,</span> <span class="n">Simulator</span><span class="p">,</span> <span class="n">SimulatorBuilder</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigLoader</span>


<div class="viewcode-block" id="Simulation">
<a class="viewcode-back" href="../../../_autogen/nqs_sdk.core.simulation.html#nqs_sdk.Simulation">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main orchestrator for running simulations.</span>

<span class="sd">    This class serves as the primary interface for users to configure, build, and execute</span>
<span class="sd">    simulations involving multiple DeFi protocols. It handles the coordination between</span>
<span class="sd">    protocol factories, configuration loading, and simulation execution.</span>

<span class="sd">    Protocols and configuration are provided during initialization, and the simulation</span>
<span class="sd">    can be run multiple times with different parameters.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        protocols: List of protocol factories or protocol factory adapters that define the DeFi protocols to simulate</span>
<span class="sd">        config: Configuration data (file path, dict, or YAML/JSON content)</span>
<span class="sd">        simulator: Internal rust-based simulator instance (built lazily)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Simulation.__init__">
<a class="viewcode-back" href="../../../_autogen/nqs_sdk.core.simulation.html#nqs_sdk.Simulation.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">protocols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ProtocolFactory</span> <span class="o">|</span> <span class="n">ProtocolFactoryAdapter</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ProtocolFactory</span> <span class="o">|</span> <span class="n">ProtocolFactoryAdapter</span><span class="p">]],</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a new simulation with specified protocols and configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            protocols: Single ProtocolFactory or ProtocolFactoryAdapter,</span>
<span class="sd">                       or list of ProtocolFactorys or ProtocolFactoryAdapters defining</span>
<span class="sd">                       the protocols to include in the simulation</span>
<span class="sd">            config: Configuration for the simulation. Can be:</span>
<span class="sd">                   - Path to a YAML/JSON configuration file</span>
<span class="sd">                   - Dictionary containing configuration parameters</span>
<span class="sd">                   - String containing YAML/JSON configuration content</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from nqs_sdk import Simulation</span>
<span class="sd">            &gt;&gt;&gt; from nqs_sdk.protocols import UniswapV3Factory</span>
<span class="sd">            &gt;&gt;&gt; from nqs_sdk_extension.protocols import CompoundV2Factory</span>
<span class="sd">            &gt;&gt;&gt; uniswap = UniswapV3Factory()</span>
<span class="sd">            &gt;&gt;&gt; compound = CompoundV2Factory()</span>
<span class="sd">            &gt;&gt;&gt; sim = Simulation([uniswap, compound], &quot;config.yaml&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="p">[</span><span class="n">protocols</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">protocols</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">protocols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_backtest</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># FIXME: get this from binding instead</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method to construct the simulation from protocols and configuration.</span>

<span class="sd">        This method:</span>
<span class="sd">        1. Loads and parses the configuration (YAML or JSON)</span>
<span class="sd">        2. Creates a SimulatorBuilder with the parsed configuration</span>
<span class="sd">        3. Registers all protocol factories with the builder</span>
<span class="sd">        4. Builds the final simulator instance</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If configuration format is invalid</span>
<span class="sd">            FileNotFoundError: If configuration file doesn&#39;t exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_content</span><span class="p">,</span> <span class="n">config_format</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_backtest</span> <span class="o">=</span> <span class="s2">&quot;backtest&quot;</span> <span class="ow">in</span> <span class="n">config_content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_backtest</span> <span class="o">=</span> <span class="s2">&quot;backtest&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                <span class="s2">&quot;backtest&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">config_format</span> <span class="o">==</span> <span class="s2">&quot;yaml&quot;</span><span class="p">:</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">SimulatorBuilder</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">config_content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">SimulatorBuilder</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">config_content</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">ProtocolFactoryAdapter</span><span class="p">):</span>
                <span class="n">protocol</span> <span class="o">=</span> <span class="n">ProtocolFactoryAdapter</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_factory</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

<div class="viewcode-block" id="Simulation.get_protocol">
<a class="viewcode-back" href="../../../_autogen/nqs_sdk.core.simulation.html#nqs_sdk.Simulation.get_protocol">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a protocol instance by its identifier.</span>

<span class="sd">        Args:</span>
<span class="sd">            protocol_id: Unique identifier for the protocol (e.g., &quot;uniswap_v3&quot;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            The protocol instance corresponding to the given ID</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If simulation hasn&#39;t been built yet</span>
<span class="sd">            KeyError: If protocol_id doesn&#39;t exist in the simulation</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; uniswap_protocol = sim.get_protocol(&quot;uniswap_v3&quot;)</span>
<span class="sd">            &gt;&gt;&gt; current_price = uniswap_protocol.get_current_price()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation has not been built yet&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">get_py_protocol</span><span class="p">(</span><span class="n">protocol_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Simulation.run">
<a class="viewcode-back" href="../../../_autogen/nqs_sdk.core.simulation.html#nqs_sdk.Simulation.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the simulation and return results.</span>

<span class="sd">        This method runs the entire simulation from start to end block/timestamp,</span>
<span class="sd">        processing all transactions and collecting metrics along the way.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SimulationResults: Object containing all simulation data including:</span>
<span class="sd">                - Protocol states at each block</span>
<span class="sd">                - Agent portfolio values over time</span>
<span class="sd">                - Transaction logs and fees</span>
<span class="sd">                - Observable metrics and KPIs</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If simulation hasn&#39;t been built yet</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; results = sim.run()</span>
<span class="sd">            &gt;&gt;&gt; portfolio_value = results.get_agent_metric(&quot;alice&quot;, &quot;total_holding&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation has not been built yet&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Simulation starting...&quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">run_to_dict</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Simulation ended&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serialize the simulation configuration to JSON.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JSON representation of the complete simulation configuration,</span>
<span class="sd">            including all protocols, agents, and parameters</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If simulation hasn&#39;t been built yet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation has not been built yet&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Simulation&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deserialize a simulation from JSON configuration.</span>

<span class="sd">        This class method allows reconstructing a Simulation instance from</span>
<span class="sd">        a previously serialized JSON configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            json_data: JSON string containing simulation configuration</span>

<span class="sd">        Returns:</span>
<span class="sd">            New Simulation instance configured from the JSON data</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If JSON is malformed or contains invalid configuration</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; json_config = previous_sim.to_json()</span>
<span class="sd">            &gt;&gt;&gt; new_sim = Simulation.from_json(json_config)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulation</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">([],</span> <span class="p">{})</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="n">Simulator</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">simulation</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2025, NQS Team.
      
    </div>

    

    
  </body>
</html>